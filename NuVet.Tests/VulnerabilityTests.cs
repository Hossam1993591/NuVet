using NuVet.Core.Models;
using Semver;

namespace NuVet.Tests;

public class VulnerabilityTests
{
    [Fact]
    public void IsVersionAffected_ReturnsTrue_WhenVersionIsAffected()
    {
        // Arrange
        var vulnerability = new Vulnerability
        {
            Id = "GHSA-test-123",
            Title = "Test Vulnerability",
            Description = "Test description",
            Severity = VulnerabilitySeverity.High,
            PackageId = "TestPackage",
            AffectedVersions = new List<SemVersion> { SemVersion.Parse("1.0.0", SemVersionStyles.Strict) },
            PatchedVersions = new List<SemVersion> { SemVersion.Parse("1.1.0", SemVersionStyles.Strict) },
            AdvisoryUrl = new Uri("https://github.com/advisories/GHSA-test-123"),
            PublishedAt = DateTime.UtcNow
        };

        var testVersion = SemVersion.Parse("1.0.5", SemVersionStyles.Strict);

        // Act
        var result = vulnerability.IsVersionAffected(testVersion);

        // Assert
        Assert.True(result);
    }

    [Fact]
    public void IsVersionAffected_ReturnsFalse_WhenVersionIsPatched()
    {
        // Arrange
        var vulnerability = new Vulnerability
        {
            Id = "GHSA-test-123",
            Title = "Test Vulnerability",
            Description = "Test description",
            Severity = VulnerabilitySeverity.High,
            PackageId = "TestPackage",
            AffectedVersions = new List<SemVersion> { SemVersion.Parse("1.0.0", SemVersionStyles.Strict) },
            PatchedVersions = new List<SemVersion> { SemVersion.Parse("1.1.0", SemVersionStyles.Strict) },
            AdvisoryUrl = new Uri("https://github.com/advisories/GHSA-test-123"),
            PublishedAt = DateTime.UtcNow
        };

        var testVersion = SemVersion.Parse("1.1.0", SemVersionStyles.Strict);

        // Act
        var result = vulnerability.IsVersionAffected(testVersion);

        // Assert
        Assert.False(result);
    }

    [Fact]
    public void GetLowestPatchedVersion_ReturnsLowestVersion()
    {
        // Arrange
        var vulnerability = new Vulnerability
        {
            Id = "GHSA-test-123",
            Title = "Test Vulnerability",
            Description = "Test description",
            Severity = VulnerabilitySeverity.High,
            PackageId = "TestPackage",
            AffectedVersions = new List<SemVersion>(),
            PatchedVersions = new List<SemVersion> 
            { 
                SemVersion.Parse("1.2.0", SemVersionStyles.Strict),
                SemVersion.Parse("1.1.0", SemVersionStyles.Strict),
                SemVersion.Parse("1.3.0", SemVersionStyles.Strict)
            },
            AdvisoryUrl = new Uri("https://github.com/advisories/GHSA-test-123"),
            PublishedAt = DateTime.UtcNow
        };

        // Act
        var result = vulnerability.GetLowestPatchedVersion();

        // Assert
        Assert.NotNull(result);
        Assert.Equal("1.1.0", result.ToString());
    }
}