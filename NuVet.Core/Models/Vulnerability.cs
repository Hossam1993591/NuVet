using Semver;

namespace NuVet.Core.Models;

/// <summary>
/// Represents a security vulnerability found in a NuGet package
/// </summary>
public class Vulnerability
{
    public required string Id { get; init; }
    public required string Title { get; init; }
    public required string Description { get; init; }
    public required VulnerabilitySeverity Severity { get; init; }
    public required string PackageId { get; init; }
    public required List<SemVersion> AffectedVersions { get; init; }
    public required List<SemVersion> PatchedVersions { get; init; }
    public required Uri AdvisoryUrl { get; init; }
    public DateTime PublishedAt { get; init; }
    public DateTime? UpdatedAt { get; init; }
    public List<string> CveIds { get; init; } = new();
    public List<string> References { get; init; } = new();
    
    /// <summary>
    /// Checks if the given version is affected by this vulnerability
    /// </summary>
    public bool IsVersionAffected(SemVersion version)
    {
        return AffectedVersions.Any(affected => 
            SemVersion.ComparePrecedence(affected, version) <= 0 && 
            !PatchedVersions.Any(patched => SemVersion.ComparePrecedence(patched, version) <= 0));
    }
    
    /// <summary>
    /// Gets the lowest patched version that fixes this vulnerability
    /// </summary>
    public SemVersion? GetLowestPatchedVersion()
    {
        return PatchedVersions.OrderBy(v => v).FirstOrDefault();
    }
}

public enum VulnerabilitySeverity
{
    Unknown = 0,
    Low = 1,
    Moderate = 2,
    High = 3,
    Critical = 4
}